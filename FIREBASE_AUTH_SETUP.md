# Firebase Authentication Integration

## Overview

Your Pharmacy Calculator now includes Firebase authentication and database integration. The application uses **anonymous authentication** which allows users to save and load their business plans securely without requiring manual login.

## What Changed

### New Files Created

1. **`js/firebaseInit.js`** - Firebase initialization and anonymous authentication
2. **`js/firebaseDatabase.js`** - Database operations (save, load, update, delete plans)

### Modified Files

1. **`js/main.js`** - Updated to initialize Firebase authentication on app load

## How It Works

### Automatic Anonymous Sign-In

When the app loads, it automatically:
1. Initializes Firebase with your project credentials
2. Signs in the user anonymously (no login required)
3. Assigns a unique user ID to the anonymous session

```javascript
// This happens automatically in main.js
await initializeAnonymousAuth();
```

### User UID-Based Storage

Plans are stored in Firebase using the structure:
```
users/{user_UID}/plans/{planId}
  ├── executive_summary
  ├── plan
  ├── financial_breakdown
  ├── savedAt (ISO timestamp)
  └── ... other plan data
```

Each user has a unique UID generated by Firebase, so data is isolated per session.

## Using the Database Functions

### Save a Plan

```javascript
import { saveBusinessPlan } from "./firebaseDatabase.js";

const planData = {
  executive_summary: "...",
  plan: [...],
  financial_breakdown: {...}
};

const planId = await saveBusinessPlan(planData);
console.log(`Plan saved with ID: ${planId}`);
```

### Load a Plan

```javascript
import { loadBusinessPlan } from "./firebaseDatabase.js";

const plan = await loadBusinessPlan("plan_1234567890");
console.log("Plan loaded:", plan);
```

### Load All Plans

```javascript
import { loadAllPlans } from "./firebaseDatabase.js";

const allPlans = await loadAllPlans();
console.log("All saved plans:", allPlans);
```

### Update a Plan

```javascript
import { updateBusinessPlan } from "./firebaseDatabase.js";

await updateBusinessPlan("plan_1234567890", {
  executive_summary: "Updated summary..."
});
```

### Delete a Plan

```javascript
import { deleteBusinessPlan } from "./firebaseDatabase.js";

await deleteBusinessPlan("plan_1234567890");
```

## Accessing Current User

```javascript
import { getCurrentUser } from "./firebaseInit.js";

const user = getCurrentUser();
console.log("Current user UID:", user.uid);
```

## Firebase Configuration

The app uses environment variables for Firebase configuration. These are already set up in your `.env` file:

```
FIREBASE_API_KEY=...
FIREBASE_AUTH_DOMAIN=...
FIREBASE_DATABASE_URL=...
FIREBASE_PROJECT_ID=...
FIREBASE_STORAGE_BUCKET=...
FIREBASE_MESSAGING_SENDER_ID=...
FIREBASE_APP_ID=...
```

These environment variables are read by `js/firebaseInit.js` when the app initializes.

## Updated Firebase Rules

With anonymous authentication, your Firebase Realtime Database rules should allow authenticated users to read/write their own data:

```json
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid"
      }
    }
  }
}
```

This ensures each user can only access their own plans.

## Error Handling

All database functions include try-catch blocks and will throw descriptive errors:

```javascript
try {
  await saveBusinessPlan(planData);
} catch (error) {
  console.error("Failed to save plan:", error.message);
}
```

## Console Logging

The app provides detailed console logs for debugging:

- ✓ "User signed in anonymously with UID: ..."
- ✓ "Plan saved successfully for user ..."
- ✓ "Plan loaded successfully"
- ✗ Error messages with descriptions

## Browser Compatibility

This implementation uses modern JavaScript (ES6+ imports) and requires:
- ES6 module support
- Async/await support
- Fetch API

## Testing

To test the authentication and database functions:

1. Open the browser console (F12)
2. Check for "✓ User signed in anonymously with UID: ..."
3. Use the provided functions in the console to test:

```javascript
// Test saving a plan
const { saveBusinessPlan } = await import('./js/firebaseDatabase.js');
await saveBusinessPlan({ test: "data" });

// Test loading all plans
const { loadAllPlans } = await import('./js/firebaseDatabase.js');
const plans = await loadAllPlans();
console.log(plans);
```

## Troubleshooting

### "User not authenticated" Error

This error occurs when database functions are called before authentication completes. The app waits for authentication in `main.js`, so this shouldn't happen in normal usage. If you see it:

1. Check the console for authentication errors
2. Verify Firebase credentials in your `.env` file
3. Check your Firebase project's Authentication settings

### Firebase Rules Errors

If you see permission denied errors in the console:

1. Check your Firebase Realtime Database rules
2. Ensure they allow authenticated users to read/write under `users/{uid}/`
3. Verify your Firebase project allows anonymous authentication

### Network Errors

If database operations timeout or fail:

1. Check your internet connection
2. Verify `FIREBASE_DATABASE_URL` is correct in `.env`
3. Check Firebase console for service status

## Next Steps

You can now:

1. **Integrate plan saving** - Add a "Save Plan" button that calls `saveBusinessPlan()`
2. **Integrate plan loading** - Add a "Load Plans" button that calls `loadAllPlans()`
3. **Add plan management UI** - Create a modal to manage saved plans
4. **Implement auto-save** - Periodically save plans as users make changes

## Security Notes

- Anonymous authentication is suitable for this use case (no sensitive user data)
- Each session gets its own unique UID
- Plans are isolated per session
- Consider adding regular cleanup of old anonymous sessions in your Firebase rules
- If you add real user authentication later, migrate anonymous plans with `linkWithCredential()`
